<div class="c-map">
  <google-map
    height="100svh"
    width="100%"
    [options]="mapOptions"
    (mapInitialized)="onMapInit($event)"
  >


    <div class="c-map-toolbar-horizontal">
      <p-button
        label="Filter"
        styleClass="p-button-map text-base max-[480px]:text-xs"
        (click)="onVisibleFilterChange(isFilterVisible)"
        [outlined]="true"
      >

        <ng-template
          #icon
          let-checked
        >


          <svg
            xmlns="http://www.w3.org/2000/svg"
            style="color: var(--p-surface-700);"
            viewBox="0 0 960 960"
            width="16"
            height="16"
          >
            <path
              fill="currentColor"
              d="M109.33333333333331 908.6666666666665v-392h-109.33333333333333v-80h298.66666666666663v80h-109.33333333333333v392h-80Zm0-552v-301.3333333333333h80v301.3333333333333h-80Zm221.33333333333331-54.666666666666664v-80h109.33333333333333v-166.66666666666666h80v166.66666666666666h109.33333333333333v80H330.66666666666663Zm109.33333333333333 606.6666666666666v-526.6666666666666h80v526.6666666666666h-80Zm330.66666666666663 0v-169.33333333333331h-109.33333333333333v-80h298.66666666666663v80h-109.33333333333333v169.33333333333331h-80Zm0-329.3333333333333v-524h80v524h-80Z"
            />
          </svg>

        </ng-template>
      </p-button>
      <div class="flex-fill"></div>
      <div class="c-map__left-offset">
        <p-button
          [label]="
    totalCount
      ? ('Showing ' + shownCount + ' of ' + totalCount + (isFiltered ? '' : ''))
      : 'loading...'
  "
          [outlined]="true"
          [disabled]="!totalCount"
          styleClass="p-button-map text-base max-[480px]:text-xs"
        >
        </p-button>

      </div>
      <div class="flex-fill"></div>
    </div>

    <div class="c-map-toolbar-vertical">


      <p-selectbutton
        styleClass="icon-only-toggle p-button-icon-only p-button-map mb-4"
        [options]="modeOptions"
        [(ngModel)]="modevalue"
        (onChange)="onChangesMode($event)"
        [optionLabel]="'justify'"
        [optionValue]="'justify'"
        [allowEmpty]="false"
        [unselectable]="false"
      >
        <ng-template
          pTemplate="item"
          let-item
        >
          <ng-container *ngComponentOutlet="isSelected(item) ? item.iconSelected : item.icon"></ng-container>
        </ng-template>
      </p-selectbutton>

      <div class="c-map__y-offset"></div>
      <div class="c-map__y-offset"></div>
      <div class="flex-fill"></div>
      <div class="c-map__y-offset"></div>
      <map-zoom-control></map-zoom-control>
      <div class="flex-fill"></div>

      <div class="c-map__y-offset"></div>

      <div class="flex-fill"></div>

    </div>

    <p-drawer
      [(visible)]="isVisible"
      [closable]="false"
      modal="false"
      appendTo=""
      styleClass="p-drawer-bottom-append h-[25rem]! "
      [modal]="false"
      (visibleChange)="onVisibleSearchChange($event)"
      position="bottom"
    >

      <ng-template #header>

        <div class="flex items-center justify-between w-full mb-0 gap-2">
          <div class="text-900 text-xl font-semibold whitespace-nowrap">Search by proximity</div>

          <div class="flex items-center ml-auto">
          </div>
        </div>
      </ng-template>
      <ng-template #content>
        <map-isochrone
          #isochrone
          (addFeature)="onAddFeature($event, isochrone)"
          (removeFeature)="onRemoveFeature($event, isochrone)"
        >

        </map-isochrone>
      </ng-template>
    </p-drawer>


    <p-drawer
      [(visible)]="isVisibleInwofindow"
      position="bottom"
      [closable]="false"
      modal="false"
      appendTo=""
      styleClass="p-drawer-bottom-append h-[20rem]!"
    >
      <ng-template #header>
        <div class="flex items-center justify-between gap-2 w-full">
          <h2
            class="text-900 text-xl font-semibold truncate"
            [attr.aria-label]="selectedPoint?.data?.title"
          >
            {{ selectedPoint?.data?.title }}


          </h2>

          <p-button
            [rounded]="true"
            (click)="onClose(false)"
            severity="secondary"
            aria-label="Close"
          >
            <ng-template #icon>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 960 960"
                width="16"
                height="16"
              >
                <path
                  d="M73.846 962 0 888.154l406.154-406.154L0 75.846 73.846 2l406.154 406.154L886.154 2 960 75.846 553.846 482 960 888.154 886.154 962 480 555.846 73.846 962Z"
                />
              </svg>
            </ng-template>
          </p-button>
        </div>
      </ng-template>

      <ng-template #content>
        <ng-container *ngIf="selectedPoint as sp">
          <div
            class="h-1.5 w-full"
            [style.background]="sp.data?.typeColor"
          ></div>

          <div class="p-4 flex gap-3">

            <div class="min-w-0 flex-1">
              <div class="flex items-start justify-between gap-2">
                <h3 class="text-base font-semibold text-gray-900 truncate">
                  {{ sp.data?.company }}
                </h3>
                <span
                  class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
                  [style.background]="(sp.data?.typeColor || '#0B5FD7') + '22'"
                  [style.color]="sp.data?.typeColor || '#0B5FD7'"
                >
                  {{ sp.data?.type }}
                </span>
              </div>


              <div class="mt-2 flex flex-wrap items-center gap-x-3 gap-y-1 text-xs text-gray-600">
                <span class="inline-flex items-center gap-1">
                  <svg
                    class="size-3.5"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M6 7h12v10a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V7Zm0-2a2 2 0 0 1 2-2h1v2h4V3h1a2 2 0 0 1 2 2v1H6V5Z"
                    />
                  </svg>
                  {{ sp.data?.employment | titlecase }}
                </span>
                <span>•</span>
                <span class="inline-flex items-center gap-1">
                  <svg
                    class="size-3.5"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M12 2a7 7 0 0 1 7 7c0 5.25-7 13-7 13S5 14.25 5 9a7 7 0 0 1 7-7Zm0 9.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"
                    />
                  </svg>
                  {{ sp.data?.city }}, {{ sp.data?.country }}
                </span>
              </div>

              <div class="mt-3 flex items-center justify-between">
                <div class="text-sm font-semibold text-gray-900">
                  {{ sp.data?.salaryEUR | currency:'EUR':'symbol':'1.0-0' }}
                  <span class="text-xs font-normal text-gray-500">/ year</span>
                </div>
                <div class="text-xs text-gray-500">
                  {{ sp.data?.postedAt | date:'mediumDate' }}
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 w-full">
            <p-button
              label="Respond"
              [raised]="true"
              styleClass="w-full justify-center"
            />
          </div>
        </ng-container>
      </ng-template>
    </p-drawer>



    <p-drawer
      [(visible)]="isFilterVisible"
      [closable]="false"
      modal="false"
      appendTo=""
      styleClass="p-drawer-bottom-append max-[480px]:h-[100dvh]!  
    md:h-[60rem]!"
      [modal]="false"
      position="bottom"
    >

      <ng-template #header>

        <div class="flex items-center justify-between w-full mb-0 gap-2">
          <div class="text-900 text-xl font-semibold whitespace-nowrap">Filter</div>

          <div class="flex items-center ml-auto">
            <p-button
              [rounded]="true"
              (click)="onVisibleFilterChange(isFilterVisible)"
              severity="secondary"
            >
              <ng-template
                #icon
                let-checked
              >

                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 960 960"
                  width="16"
                  height="16"
                >
                  <path
                    d="M73.84615384615381 962l-73.84615384615384-73.84615384615384 406.15384615384613-406.15384615384613-406.15384615384613-406.15384615384613 73.84615384615384-73.84615384615384 406.15384615384613 406.15384615384613 406.15384615384613-406.15384615384613 73.84615384615384 73.84615384615384-406.15384615384613 406.15384615384613 406.15384615384613 406.15384615384613-73.84615384615384 73.84615384615384-406.15384615384613-406.15384615384613-406.15384615384613 406.15384615384613Z"
                  />
                </svg>

              </ng-template>
            </p-button>
          </div>
        </div>
      </ng-template>
      <ng-template #content>
        <app-map-filter [items]="allPointsFC?.features"></app-map-filter>
      </ng-template>
    </p-drawer>



    <map-drawing-control
      #drawing
      (addFeature)="onAddFeature($event, drawing)"
      (removeFeature)="onAddFeature($event, drawing)"
      [style]="style"
    ></map-drawing-control>
    <app-marker-clusterer
      [map]="map"
      [points]="points"
      [algorithm]="'super'"
      [gridSize]="220"
      [maxZoom]="18"
    >
      <ng-template
        #marker
        let-point
      >
        <div
          class="relative inline-flex items-center justify-center"
          (click)="selectPoint(point)"
        >

          <div
            class="job-dot"
            [style.--dot-color]="point?.data?.typeColor || '#0B5FD7'"
            [attr.title]="point?.data?.type || point?.title || ''"
          >
          </div>

          <div
            *ngIf="point?.data?.id === selectedPointId"
            class="pointer-events-none select-none
         absolute left-1/2 -translate-x-1/2
         bottom-[calc(100%+12px)] z-[2]
         max-[480px]:bottom-[calc(100%+8px)]"
          >
            <div
              class="inline-flex items-center rounded-full px-3 py-1
           text-[13px] font-semibold text-white
           shadow-[0_6px_16px_rgba(0,0,0,.25)]
           whitespace-nowrap
           max-[480px]:px-2 max-[480px]:py-0.5
           max-[480px]:text-[11px] max-[480px]:rounded-md"
              [style.background]="point?.data?.typeColor || '#3B82F6'"
            >
              {{ point?.data?.salaryEUR | number:'1.0-0' }}&nbsp;€/year
            </div>

            <svg
              class="absolute left-1/2 -translate-x-1/2 top-[calc(100%-1px)]
           w-4 h-2.5 max-[480px]:w-3 max-[480px]:h-2"
              viewBox="0 0 16 10"
              aria-hidden="true"
            >
              <path
                [attr.fill]="point?.data?.typeColor || '#3B82F6'"
                d="M8,10 C8,10 11,5 16,0 H0 C5,5 8,10 8,10 Z"
              />
            </svg>
          </div>
        </div>
      </ng-template>


      <ng-template
        #cluster
        let-count="count"
      >
        <div
          class="cluster-pin-svg"
          [attr.title]="count + ' результатов'"
        >
          <svg
            viewBox="0 0 44 56"
            aria-hidden="true"
            class="cluster-svg"
          >
            <path
              fill="#E33D33"
              d="M22 4
             C12 4 4 12 4 22
             C4 30 14 43 22 52
             C30 43 40 30 40 22
             C40 12 32 4 22 4Z"
            />
            <text
              x="22"
              y="22"
              text-anchor="middle"
              dominant-baseline="middle"
              font-family="Inter, system-ui, Arial, sans-serif"
              font-weight="700"
              font-size="14"
              fill="#FFFFFF"
            >
              {{ count }}
            </text>
          </svg>
        </div>
      </ng-template>
    </app-marker-clusterer>

  </google-map>
</div>